<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 12px sans-serif;
}

path {
  stroke-width: 1px;
  stroke: white;
  fill: steelblue;
  cursor: pointer;
}

path:hover, path.highlighted {
  fill: tomato;
}

text {
  font: 10px sans-serif;
}

.scatter-axis path,
.scatter-axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.dot {
  stroke: #000;
}

.tooltip {
  position: absolute;
  width: 200px;
  height: 28px;
  pointer-events: none;
}

.slider .handle {
  fill: #fff;
  stroke: #000;
  stroke-opacity: .5;
  stroke-width: 1.25px;
  cursor: crosshair;
}

</style>

<body>

</body>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var GLOBAL = {data: [], margin: {top: 20, right: 20, bottom: 30, left: 40}, width: 600, height: 500};
window.addEventListener("load", run);

function run() {

	//Create SVGs
	var svg_map = d3.select("body").append("svg")
	    .attr("width", GLOBAL.width)
	    .attr("height", GLOBAL.height)
      .attr("id", "map");

	var svg_scatter = d3.select("body").append("svg")
	    .attr("width", GLOBAL.width)
	    .attr("height", GLOBAL.height)
      .attr("id", "scatter");

	//Map projection
  var projection = d3.geo.albersUsa()
	    .scale(730.2209486090715)
	    .translate([GLOBAL.width/2,GLOBAL.height/2]) //translate to center the map in view

	//Generate paths based on projection
	var path = d3.geo.path()
	    .projection(projection);

	//Group for the map features
	var features = svg_map.append("g")
	    .attr("class","features");

  //load data from database
	d3.json("states", function(error, data){
		if (error){
			console.log(error);
		} else {
			GLOBAL.data = data;
		}
	});

  //load data for creating map 
	d3.json("us-states.geojson",function(error,geodata) {
	  if (error) return console.log(error); //unknown error, check the console
  //Create a path for each map feature in the data
    features.selectAll("path")
    .data(geodata.features)
    .enter()
    .append("path")
    .attr("d",path)
    .on("click",function(d,i){clicked(i)});
  }); 
}

function updateText(i){
  var svg = d3.select("#scatter");
  svg.selectAll("*").remove();

  //adding/updating text
  svg.append("text")
  .attr("x",+svg.attr("width")/2)
  .attr("y", 20)
  .attr("dy","0.35em")
  .style("text-anchor","middle")
  .style("font-family","sans-serif")
  .style("font-size","20pt")
  .text("Colleges in "+ STATENAME[i]+" what");
  //
}

// Update scatter plot when a state is clicked
function updateScatter(i){

  var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

  var width = 600 - GLOBAL.margin.left - GLOBAL.margin.right,
      height = 500 - GLOBAL.margin.top - GLOBAL.margin.bottom;

  var state = STATENAME[i];
  state_objects = GLOBAL.data.states[state];

  var cost = state_objects.map(function(d) {
    return d.cost;
  });

  var mv_combined = state_objects.map(function(d) {
    return d.math + d.verbal;
  });

  var students  = state_objects.map(function(d) {
    return d.students;
  });

  var xScale = d3.scale.linear()
                        .domain([600, 1600])
                        .range([0, width-GLOBAL.margin.right]),
      xValue = function(d) { return d['math'] + d['verbal'];},
      xMap = function(d) { return xScale(xValue(d));},
      xAxis = d3.svg.axis().scale(xScale).orient("bottom");

  var yScale = d3.scale.linear()
                        .domain([0, 60000])
                        .range([height,GLOBAL.margin.top]),
      yValue = function(d) { return d['cost'];},
      yMap = function(d) { return yScale(yValue(d)); },
      yAxis = d3.svg.axis().scale(yScale).orient("left");

  //map for size of college
  var studentValue = function(d) {return d['students'];},
    studentScale = d3.scale.linear().domain([0,d3.max(students)]).range([5,15]), // max radius of 5
    studentMap = function(d) { return studentScale(studentValue(d)); };

  console.log(state_objects);

  // x-axis
  var svg = d3.select("#scatter");
  svg.append("g")
      .attr("class", "x scatter-axis")
      .attr("transform", "translate(" + GLOBAL.margin.left + "," + height + ")")
      .call(xAxis)
    .append("text")
      .style("text-anchor", "end")
      .attr("transform", "translate(" + 0 + "," + width + ")")
      .text("Combined Math and Verbal SAT Scores")

  // y-axis
  svg.append("g")
      .attr("class", "y scatter-axis")
      .attr("transform", "translate(" + GLOBAL.margin.left + "," + "0)")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("transform", "translate(" + width + "," + "0)")
      .style("text-anchor", "end")
      .text("Total Cost of Attendance")

  // add dots
  svg.selectAll(".dot")
      .data(state_objects)
    .enter().append("circle")
      .attr("class", "dot")
      .attr("transform", "translate(" + GLOBAL.margin.left + "," + "0)")
      .attr("r", studentMap)
      .attr("cx", xMap)
      .attr("cy", yMap)
      .on("mouseover", function(d) {
          tooltip.transition()
               .duration(200)
               .style("opacity", .9);
          tooltip.html(d["college"] 
                      + "<br/> Students: " + d["students"]
                      + "<br/> Math: " + d["math"]
                      + "<br/> Verbal: " + d["verbal"])
               .style("left", (d3.event.pageX + 5) + "px")
               .style("top", (d3.event.pageY - 28) + "px");
      })
      .on("mouseout", function(d) {
          tooltip.transition()
               .duration(500)
               .style("opacity", 0);
      });
}

// Add optional onClick events for features here
// d.properties contains the attributes (e.g. d.properties.name, d.properties.population)
function clicked(i) {
  updateText(i);
  updateScatter(i);
}

var STATENAME = {
  "0":"AL",
  "1":"AK",
  "2":"AZ",
  "3":"AR",
  "4":"CA",
  "5":"CO",
  "6":"CT",
  "7":"DE",
  "8":"DC",
  "9":"FL",
  "10":"GA",
  "11":"HI",
  "12":"ID",
  "13":"IL",
  "14":"IN",
  "15":"IA",
  "16":"KS",
  "17":"KY",
  "18":"LA",
  "19":"ME",
  "20":"MD",
  "21":"MA",
  "22":"MI",
  "23":"MN",
  "24":"MS",
  "25":"MO",
  "26":"MT",
  "27":"NE",
  "28":"NV",
  "29":"NH",
  "30":"NJ",
  "31":"NM",
  "32":"NY",
  "33":"NC",
  "34":"ND",
  "35":"OH",
  "36":"OK",
  "37":"OR",
  "38":"PA",
  "39":"RI",
  "40":"SC",
  "41":"SD",
  "42":"TN",
  "43":"TX",
  "44":"UT",
  "45":"VT",
  "46":"VA",
  "47":"WA",
  "48":"WV",
  "49":"WI",
  "50":"WY"
}

/*
 * Pulls the data
 * 
 */

function getData (f) {
    d3.json("data",function(error,data) {
		if (error) {
		    //d3.selectAll(".loading").remove();
		    console.log(error);
		} else {
		    //d3.selectAll(".loading").remove();
		    //console.log("data =", data);
		    GLOBAL.data = data;
		    f(data);
		}
	});
}

</script>